# CV Fatigue Detection Model - Integration Files Guide

## Overview
This guide lists all files required to integrate the fatigue detection model into a different web application.

---

## üìã Essential Files to Copy

### 1. **Main Application Files**

#### `app.py` ‚≠ê CRITICAL
- **Purpose**: Flask REST API server for computer vision inference
- **Port**: 5000
- **Endpoints**:
  - `POST /detect` - YOLOv8 object detection
  - `POST /landmarks` - MediaPipe facial landmarks extraction
  - `POST /infer` - Combined detection + landmarks
  - `GET /health` - Health check
- **Size**: ~9.7 KB
- **Status**: Production-ready

#### `webcam_demo.py` (Optional)
- **Purpose**: Real-time webcam demonstration with fatigue detection logic
- **Features**:
  - Eye Aspect Ratio (EAR) calculation for drowsiness detection
  - Yawning detection via mouth openness
  - Head pose estimation for distraction detection
  - Phone usage detection
- **Size**: ~13.2 KB
- **Status**: Demo/testing only, not required for production API

---

### 2. **Model Files** (REQUIRED - Large files)

#### `yolov8n.pt` ‚≠ê CRITICAL
- **Purpose**: YOLOv8 Nano pre-trained model for object detection
- **Size**: ~6.3 MB
- **Function**: Detects people, phones, and other objects in frames
- **Auto-download**: If missing, `app.py` will attempt to download on first startup
- **Venue**: Can be auto-generated by ultralytics library

#### `face_landmarker_v2_with_blendshapes.task` ‚≠ê CRITICAL
- **Purpose**: MediaPipe FaceLandmarker model for 468 facial landmarks
- **Size**: ~50-100 MB (large!)
- **Function**: Detects eye landmarks, mouth landmarks, head pose
- **Critical for**: Drowsiness detection, yawning detection, head pose analysis
- **Note**: Can also be auto-downloaded if missing (see setup files)

---

### 3. **Python Dependencies**

#### `requirements.txt` ‚≠ê CRITICAL
- **Purpose**: All Python package dependencies
- **Contents**:
  ```
  flask==3.0.3
  numpy==1.26.4
  opencv-python==4.9.0.80
  torch==2.1.2
  torchvision==0.16.2
  ultralytics==8.1.41
  mediapipe==0.10.21
  ```
- **Install command**:
  ```bash
  pip install -r requirements.txt
  ```

---

### 4. **Setup/Deployment Scripts** (Optional but Recommended)

#### `setup.bat` (Windows)
- **Purpose**: Automated setup for Windows
- **Steps**:
  1. Creates Python virtual environment
  2. Installs dependencies
  3. Downloads YOLOv8 model
- **Run**: `setup.bat`

#### `setup.sh` (Linux/Mac)
- **Purpose**: Automated setup for Linux/Mac
- **Run**: `bash setup.sh`

#### `start_cv_service.bat` (Windows)
- **Purpose**: Start the Flask server on Windows
- **Default port**: 5000

---

## üì¶ File Structure for New Web App

```
your-new-webapp/
‚îú‚îÄ‚îÄ cv_service/
‚îÇ   ‚îú‚îÄ‚îÄ app.py                                    # Main API
‚îÇ   ‚îú‚îÄ‚îÄ requirements.txt                          # Dependencies
‚îÇ   ‚îú‚îÄ‚îÄ yolov8n.pt                               # Model file
‚îÇ   ‚îú‚îÄ‚îÄ face_landmarker_v2_with_blendshapes.task # Model file
‚îÇ   ‚îú‚îÄ‚îÄ webcam_demo.py                           # Optional: for testing
‚îÇ   ‚îú‚îÄ‚îÄ setup.bat                                # Optional: Windows setup
‚îÇ   ‚îú‚îÄ‚îÄ setup.sh                                 # Optional: Linux setup
‚îÇ   ‚îî‚îÄ‚îÄ start_cv_service.bat                     # Optional: Windows launcher
‚îî‚îÄ‚îÄ ... (rest of your webapp)
```

---

## üöÄ Integration Steps

### Step 1: Copy Files
Copy all files from the `ESSENTIAL FILES` section above to your new webapp

### Step 2: Install Dependencies
```bash
cd cv_service
pip install -r requirements.txt
```

This will automatically install:
- **Flask**: REST API framework
- **OpenCV**: Image processing
- **PyTorch**: Deep learning framework
- **UltraLytics**: YOLOv8 model
- **MediaPipe**: Facial landmark detection
- **NumPy**: Numerical operations

### Step 3: Verify Model Files
Ensure these files exist:
- `yolov8n.pt`
- `face_landmarker_v2_with_blendshapes.task`

If missing, they will auto-download on first API call (may take 2-3 minutes)

### Step 4: Start the Service
```bash
python app.py
```

Server will start on `http://localhost:5000`

### Step 5: Test with Health Check
```bash
curl http://localhost:5000/health
```

Expected response:
```json
{
  "status": "healthy",
  "service": "CV Service",
  "models": ["YOLOv8n", "MediaPipe Face Mesh"],
  "timestamp": "2026-01-18T..."
}
```

---

## üìù Complete File Checklist

Copy these files in order of importance:

### Tier 1: MUST HAVE
- [ ] `app.py`
- [ ] `requirements.txt`
- [ ] `yolov8n.pt`
- [ ] `face_landmarker_v2_with_blendshapes.task`

### Tier 2: RECOMMENDED
- [ ] `webcam_demo.py` (for testing/validation)
- [ ] `setup.bat` or `setup.sh` (automated setup)
- [ ] `start_cv_service.bat` (Windows launcher)

### Tier 3: OPTIONAL
- [ ] Any other `.py` files for additional functionality

---

## üîß API Usage Examples

### Example 1: Object Detection
```python
import requests
import base64
import cv2

# Read image
img = cv2.imread('image.jpg')
_, img_encoded = cv2.imencode('.jpg', img)
img_b64 = base64.b64encode(img_encoded).decode()

# Send to API
response = requests.post('http://localhost:5000/detect', json={
    'frame': img_b64
})

detections = response.json()
print(detections)
```

### Example 2: Facial Landmarks
```python
response = requests.post('http://localhost:5000/landmarks', json={
    'frame': img_b64
})

landmarks = response.json()
print(f"Face detected: {landmarks['detected']}")
print(f"Landmarks: {len(landmarks['landmarks'])} points")
```

### Example 3: Combined Inference
```python
response = requests.post('http://localhost:5000/infer', json={
    'frame': img_b64
})

result = response.json()
print(f"Detections: {result['detections']}")
print(f"Face detected: {result['face_detected']}")
print(f"Processing time: {result['timing']['total_ms']}ms")
```

---

## ‚öôÔ∏è System Requirements

- **Python**: 3.8+
- **RAM**: 8GB minimum (models load into memory)
- **GPU**: Optional (CPU works, slower)
- **Disk Space**: 
  - `yolov8n.pt`: ~6 MB
  - `face_landmarker_v2_with_blendshapes.task`: ~50-100 MB
  - Dependencies: ~2-3 GB (PyTorch, etc.)

---

## üêõ Troubleshooting

### Model Download Fails
- Manually download from:
  - YOLOv8: https://github.com/ultralytics/assets/releases/download/v0.0.0/yolov8n.pt
  - Face Landmarker: MediaPipe models directory

### Port 5000 Already in Use
- Change port in `app.py` line: `app.run(port=8080)`

### Out of Memory
- Reduce image resolution before sending to API
- Use YOLOv8 nano model (already using this)

### Slow Performance
- Enable GPU support by installing `torch` with CUDA

---

## üìä Performance Metrics

- **YOLO Detection**: ~30-50ms per frame (CPU)
- **MediaPipe Landmarks**: ~10-20ms per frame (CPU)
- **Combined Inference**: ~50-80ms per frame (CPU)
- **Throughput**: ~12-20 FPS on CPU

---

## ‚úÖ Verification Checklist Before Integration

- [ ] All files copied to new webapp
- [ ] `requirements.txt` installed
- [ ] Model files present or can be auto-downloaded
- [ ] Port 5000 is available (or changed)
- [ ] Flask server starts without errors
- [ ] `/health` endpoint responds
- [ ] Sample image inference works

---

**Last Updated**: January 18, 2026
**CV Service Version**: Production-Ready
